<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MVP • Upload de Email</title>
  <link rel="stylesheet" href="/styles/index.css" />
</head>

<body>
  <div class="container">
    <div class="glass-container">
      <nav class="navbar">
        <div class="logo">
          <a href="/">jnalencar</a>
        </div>
        <ul class="nav-links">
          <li class="nav-link"><a href="/">Home</a></li>
          <li class="nav-link"><a href="/projects.html">Projetos</a></li>
          <li class="nav-link"><a href="/about.html">Sobre</a></li>
        </ul>
      </nav>
      <div class="socials">
        <ul class="nav-socials">
          <li class="nav-social"><a href="https://github.com/jnalencar" target="_blank"><img
                src="images/github-logo.png" alt=""></a></li>
          <li class="nav-social"><a href="mailto:jonathannalencar@gmail.com" target="_blank"><img
                src="images/gmail-logo.png" alt=""></a></li>
          <li class="nav-social"><a href="https://www.linkedin.com/in/jnalencar/" target="_blank"><img
                src="images/linkedin-logo.png" alt=""></a></li>
        </ul>
      </div>
      <div class="content">
        <form id="emailForm" class="body" autocomplete="off">
          <div class="row">
            <h2>Texto do email</h2>
            <textarea id="emailText" placeholder="Cole aqui o corpo do email ou solte um .txt na área ao lado..."></textarea>
            <div class="hint">Aceita texto simples. Cabeçalhos (From/To/Subject) são opcionais.</div>
            <br>
            <br>
          </div>
      
          <div class="row two">
            <div class="row">
              <h3>Anexar arquivo (.txt, .pdf ou .eml)</h2>
              <div id="drop" class="drop">
                <div class="pill">Arraste e solte aqui</div>
                <small>ou clique para selecionar</small>
                <input id="fileInput" type="file" accept=".txt,.pdf,.eml" style="display:none" />
                <div id="fileInfo" class="hint"></div>
              </div>
            </div>
      
            <div class="row">
              <h3>Assunto (opcional)</h3>
              <input id="subject" type="text" placeholder="   Ex.: Atualização sobre solicitação #12345"
                style="width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(2,6,23,.6);color:var(--ink);outline:none; padding:18px 0px" />
            </div>
          </div>
      
          <div class="actions">
            <button type="button" class="ghost" id="clearBtn">Limpar</button>
            <button type="submit">Processar</button>
          </div>
          <br>
          <div id="results" class="results">
            <div class="result-header">
              <div class="status-indicator">
                <span id="statusDot" class="status-dot"></span>
                <span id="statusText" class="status-text"></span>
              </div>
            </div>
            
            <div class="response-content">
              <h4>Sugestão de Resposta:</h4>
              <div id="responseText" class="response-text"></div>
            </div>
            
            <div id="errorSection" class="error-section" style="display: none;">
              <h4>⚠️ Erro:</h4>
              <div id="errorText" class="error-text"></div>
            </div>
            
            <div class="hint">Análise realizada pela IA usando Google Gemini.</div>
          </div>
          <br>
          <div class="attrebute"><img src="images/sign.png" alt=""></div>
        </form>
      </div>
    </div>
  </div>

  <script>
    const drop = document.getElementById('drop');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const emailText = document.getElementById('emailText');
    const subject = document.getElementById('subject');
    const form = document.getElementById('emailForm');
    const results = document.getElementById('results');
    const clearBtn = document.getElementById('clearBtn');

    // Elementos da nova interface de resposta
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const responseText = document.getElementById('responseText');
    const errorSection = document.getElementById('errorSection');
    const errorText = document.getElementById('errorText');

    // URL da API - trocar para produção
    const API_URL = window.location.hostname === 'localhost' 
      ? 'http://127.0.0.1:8000' 
      : 'https://autoufe.vercel.app';

    function displayResponse(data) {
      // Determina se é produtivo ou improdutivo
      const isProductive = data.categoria && data.categoria.toLowerCase() === 'produtivo';
      
      // Atualiza o indicador de status
      statusDot.className = `status-dot ${isProductive ? 'productive' : 'unproductive'}`;
      statusText.textContent = data.categoria || 'Categoria não definida';
      
      // Exibe a resposta sugerida
      if (data.resposta) {
        responseText.textContent = data.resposta;
      } else {
        responseText.textContent = 'Nenhuma resposta foi gerada.';
      }
      
      // Exibe erros apenas se existirem
      if (data.erro && data.erro !== null) {
        errorSection.style.display = 'block';
        errorText.textContent = data.erro;
      } else {
        errorSection.style.display = 'none';
      }
    }

    const openPicker = () => fileInput.click();

    drop.addEventListener('click', openPicker);

    const prevent = e => { e.preventDefault(); e.stopPropagation(); };

    ;['dragenter', 'dragover'].forEach(evt => drop.addEventListener(evt, e => { prevent(e); drop.classList.add('dragover'); }));
    ;['dragleave', 'drop'].forEach(evt => drop.addEventListener(evt, e => { prevent(e); drop.classList.remove('dragover'); }));

    // Variável para armazenar arquivo selecionado via drag&drop
    let selectedFile = null;

    drop.addEventListener('drop', e => {
      const f = e.dataTransfer.files?.[0];
      if (f) {
        selectedFile = f;  // Armazena o arquivo
        handleFile(f);
      }
    });
    fileInput.addEventListener('change', e => {
      const f = e.target.files?.[0];
      if (f) {
        selectedFile = f;  // Armazena o arquivo
        handleFile(f);
      }
    });

    function handleFile(file) {
      fileInfo.textContent = `${file.name} • ${(file.size / 1024).toFixed(1)} KB • Arquivo será processado pelo backend`;
      // Não preenche a caixa de texto - arquivo será processado internamente no backend
    }

    form.addEventListener('submit', async e => {
      e.preventDefault();

      const bodyText = emailText.value?.trim() || '';
      const subj = subject.value?.trim() || '';
      // Usa selectedFile (drag&drop) ou fileInput.files[0] (click)
      const file = selectedFile || fileInput.files?.[0] || null;

      const formData = new FormData();

      // Sempre adiciona os campos, mesmo que vazios
      formData.append('body', bodyText);
      formData.append('subject', subj);

      if (file) {
        formData.append('file', file);
      }

      try {
        const res = await fetch(`${API_URL}/processar`, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const json = await res.json();
        displayResponse(json);
        results.style.display = 'block';
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      } catch (err) {
        console.error('Erro completo:', err);
        alert('Erro ao enviar para o backend: ' + err.message);
      }
    });

    clearBtn.addEventListener('click', () => {
      emailText.value = '';
      subject.value = '';
      fileInput.value = '';
      selectedFile = null;  // Limpa arquivo do drag&drop
      fileInfo.textContent = '';
      results.style.display = 'none';
      
      // Limpa a nova interface de resposta
      statusDot.className = 'status-dot';
      statusText.textContent = '';
      responseText.textContent = '';
      errorSection.style.display = 'none';
      errorText.textContent = '';
    });
  </script>
</body>

</html>